generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  
  // Location
  zipcode   String?
  
  // Profile - Development & Skills
  strengths        String[] // Array of strengths
  weaknesses       String[] // Array of weaknesses
  passions         String[] // Array of passions
  developmentPath  String[] // Array of development goals
  
  // Email Verification
  emailVerified    Boolean  @default(false)
  emailVerifiedAt  DateTime?
  verificationToken String?  @unique
  
  // Payment
  stripeCustomerId      String?  @unique
  stripeSubscriptionId  String?  @unique
  subscriptionStatus    SubscriptionStatus @default(INCOMPLETE)
  subscriptionStartedAt DateTime?
  
  // Profile Completion
  profileCompleted Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships Member[]
  sessions    Session[]
  bandsCreated Band[] @relation("BandCreator")
}

enum SubscriptionStatus {
  INCOMPLETE      // Just registered, no payment yet
  ACTIVE          // Paying and verified
  PAST_DUE        // Payment failed
  CANCELED        // Subscription canceled
  TRIALING        // On trial (if we add trials later)
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// BAND
// ============================================

model Band {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  
  // Core Information
  description String @db.Text
  mission     String @db.Text
  values      String[] // Array of band values
  
  // Location
  zipcode     String?
  
  // Matching
  skillsLookingFor     String[] // Skills the band is looking for
  whatMembersWillLearn String[] // What members will learn
  
  // Visual
  imageUrl    String?
  
  // Status
  status      BandStatus @default(PENDING)
  
  // Membership Configuration
  membershipRequirements String @db.Text // Description of requirements
  whoCanApprove         MemberRole[] // Array of roles that can approve members
  
  // Metadata
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy User @relation("BandCreator", fields: [createdById], references: [id])
  members   Member[]

  @@index([createdById])
  @@index([status])
}

enum BandStatus {
  PENDING   // Less than 3 active members
  ACTIVE    // 3+ active members
  INACTIVE  // Manually deactivated or members dropped below 3
}

model Member {
  id        String   @id @default(cuid())
  userId    String
  bandId    String
  role      MemberRole
  status    MemberStatus @default(PENDING)
  
  // Invitation/Application
  invitedBy String? // userId of who invited them
  notes     String? @db.Text // Application notes or invite message
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  band Band @relation(fields: [bandId], references: [id], onDelete: Cascade)

  @@unique([userId, bandId])
  @@index([bandId])
  @@index([userId])
  @@index([status])
}

enum MemberRole {
  FOUNDER
  GOVERNOR
  MODERATOR
  CONDUCTOR
  VOTING_MEMBER
  OBSERVER
}

enum MemberStatus {
  INVITED   // Invited but not yet accepted
  PENDING   // Applied, waiting for approval
  ACTIVE    // Active member
  REJECTED  // Application rejected
}