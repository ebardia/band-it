generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  
  // Location
  zipcode   String?
  
  // Profile - Development & Skills
  strengths        String[]
  weaknesses       String[]
  passions         String[]
  developmentPath  String[]
  
  // Email Verification
  emailVerified    Boolean  @default(false)
  emailVerifiedAt  DateTime?
  verificationToken String?  @unique
  
  // Payment
  stripeCustomerId      String?  @unique
  stripeSubscriptionId  String?  @unique
  subscriptionStatus    SubscriptionStatus @default(INCOMPLETE)
  subscriptionStartedAt DateTime?
  
  // Profile Completion
  profileCompleted Boolean @default(false)
  
  // Notification Settings
  emailNotificationFrequency EmailFrequency @default(DAILY)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships             Member[]
  sessions                Session[]
  bandsCreated            Band[] @relation("BandCreator")
  notifications           Notification[]
  notificationPreferences NotificationPreference[]
  proposalsCreated        Proposal[] @relation("ProposalCreator")
  votes                   Vote[]
}

enum SubscriptionStatus {
  INCOMPLETE
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum EmailFrequency {
  REAL_TIME
  HOURLY
  DAILY
  WEEKLY
  NEVER
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id              String   @id @default(cuid())
  userId          String
  type            NotificationType
  title           String
  message         String?
  actionUrl       String?
  priority        NotificationPriority @default(MEDIUM)
  isRead          Boolean  @default(false)
  isArchived      Boolean  @default(false)
  emailedAt       DateTime?
  readAt          DateTime?
  archivedAt      DateTime?
  
  metadata        Json?
  
  relatedId       String?
  relatedType     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([userId, type])
  @@index([emailedAt])
}

enum NotificationType {
  // Band invitations
  BAND_INVITE_RECEIVED
  BAND_INVITE_ACCEPTED
  BAND_INVITE_DECLINED
  
  // Band applications
  BAND_APPLICATION_RECEIVED
  BAND_APPLICATION_APPROVED
  BAND_APPLICATION_REJECTED
  
  // Band membership
  BAND_MEMBER_JOINED
  BAND_MEMBER_LEFT
  BAND_STATUS_CHANGED
  
  // Band updates
  BAND_DETAILS_UPDATED
  
  // Proposals
  PROPOSAL_CREATED
  PROPOSAL_VOTE_NEEDED
  PROPOSAL_APPROVED
  PROPOSAL_REJECTED
  PROPOSAL_CLOSED
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model NotificationTemplate {
  id              String @id @default(cuid())
  type            NotificationType @unique
  title           String
  message         String
  emailSubject    String
  emailBody       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model NotificationPreference {
  id              String @id @default(cuid())
  userId          String
  type            NotificationType
  inApp           Boolean @default(true)
  email           Boolean @default(true)
  
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, type])
  @@index([userId])
}

// ============================================
// BAND
// ============================================

model Band {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  
  // Core Information
  description String @db.Text
  mission     String @db.Text
  values      String[]
  
  // Location
  zipcode     String?
  
  // Matching
  skillsLookingFor     String[]
  whatMembersWillLearn String[]
  
  // Visual
  imageUrl    String?
  
  // Status
  status      BandStatus @default(PENDING)
  
  // Membership Configuration
  membershipRequirements String @db.Text
  whoCanApprove         MemberRole[]
  
  // Voting Configuration
  votingMethod          VotingMethod @default(SIMPLE_MAJORITY)
  votingPeriodDays      Int @default(7)
  whoCanCreateProposals MemberRole[] @default([FOUNDER, GOVERNOR, MODERATOR, CONDUCTOR])
  
  // Metadata
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy User @relation("BandCreator", fields: [createdById], references: [id])
  members   Member[]
  proposals Proposal[]

  @@index([createdById])
  @@index([status])
}

enum BandStatus {
  PENDING
  ACTIVE
  INACTIVE
}

enum VotingMethod {
  SIMPLE_MAJORITY      // >50%
  SUPERMAJORITY_66     // >66%
  SUPERMAJORITY_75     // >75%
  UNANIMOUS            // 100%
}

model Member {
  id        String   @id @default(cuid())
  userId    String
  bandId    String
  role      MemberRole
  status    MemberStatus @default(PENDING)
  
  invitedBy String?
  notes     String? @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  band Band @relation(fields: [bandId], references: [id], onDelete: Cascade)

  @@unique([userId, bandId])
  @@index([bandId])
  @@index([userId])
  @@index([status])
}

enum MemberRole {
  FOUNDER
  GOVERNOR
  MODERATOR
  CONDUCTOR
  VOTING_MEMBER
  OBSERVER
}

enum MemberStatus {
  INVITED
  PENDING
  ACTIVE
  REJECTED
}

// ============================================
// PROPOSALS
// ============================================

model Proposal {
  id            String   @id @default(cuid())
  bandId        String
  createdById   String
  
  // Core
  title         String
  description   String @db.Text
  
  // Type & Priority
  type          ProposalType @default(GENERAL)
  priority      ProposalPriority @default(MEDIUM)
  
  // Problem & Outcome
  problemStatement    String? @db.Text
  expectedOutcome     String? @db.Text
  risksAndConcerns    String? @db.Text
  
  // Budget
  budgetRequested     Decimal? @db.Decimal(12, 2)
  budgetBreakdown     String? @db.Text
  fundingSource       String?
  
  // Timeline
  proposedStartDate   DateTime?
  proposedEndDate     DateTime?
  milestones          String? @db.Text
  
  // Attachments & Links
  attachmentUrls      String[]
  externalLinks       String[]
  
  // Voting
  status        ProposalStatus @default(OPEN)
  votingEndsAt  DateTime
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  closedAt      DateTime?

  // Relations
  band      Band @relation(fields: [bandId], references: [id], onDelete: Cascade)
  createdBy User @relation("ProposalCreator", fields: [createdById], references: [id])
  votes     Vote[]

  @@index([bandId])
  @@index([createdById])
  @@index([status])
  @@index([votingEndsAt])
  @@index([type])
}

enum ProposalType {
  GENERAL
  BUDGET
  PROJECT
  POLICY
  MEMBERSHIP
}

enum ProposalPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ProposalStatus {
  OPEN
  CLOSED
  APPROVED
  REJECTED
}

model Vote {
  id          String   @id @default(cuid())
  proposalId  String
  userId      String
  
  vote        VoteType
  comment     String? @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  user     User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([proposalId, userId])
  @@index([proposalId])
  @@index([userId])
}

enum VoteType {
  YES
  NO
  ABSTAIN
}